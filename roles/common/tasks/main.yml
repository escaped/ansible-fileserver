---
- name: Install necessities and nice-to-haves
  apt: pkg={{item}} state=installed install_recommends=no
  with_items:
    - sudo
    - vim
    - htop
    - iftop
    - iotop
    - unzip
    - mosh
    - git

- name: set hostname
  template: src=hostname.j2 dest=/etc/hostname

- name: set default shell for useradd
  lineinfile: dest=/etc/default/useradd regexp="^SHELL=" line="SHELL=/bin/bash"

- name: add wheezy backports (deb)
  apt_repository: repo="deb http://ftp.debian.org/debian/ wheezy-backports main contrib non-free" update_cache=yes state=present
  register: repo_added

- name: add wheezy backports (deb-src)
  apt_repository: repo="deb-src http://ftp.debian.org/debian/ wheezy-backports main contrib non-free" update_cache=yes state=present

- name: update repo cache
  apt: update_cache=yes
  when: repo_added|changed

- name: install latest kernel from backports
  apt: pkg={{item}} default_release=wheezy-backports state=latest install_recommends=no
  with_items:
    - linux-headers-amd64
    - linux-image-amd64
  register: kernel_updated

- name: restart machine
  command: reboot
  async: 0
  poll: 0
  ignore_errors: true
  when: kernel_updated|changed

- name: waiting for server to come back
  local_action: wait_for host={{inventory_hostname}}
                port={{ansible_ssh_port}} state=started
  sudo: false
  when: kernel_updated|changed

- include: users.yml tags=users
- include: ufw.yml tags=ufw
- include: security.yml tags=security
- include: ntp.yml tags=ntp
